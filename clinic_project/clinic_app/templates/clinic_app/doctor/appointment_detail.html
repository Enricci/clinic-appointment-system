{% extends "clinic_app/base.html" %}
{% block title %}Appointment Details{% endblock %}

{% block content %}
<div class="appointment-detail-container">
  <div class="detail-header">
    <div class="header-content">
      <a href="{% url 'clinic_app:doctor_dashboard' %}" class="back-button">
        Back to Dashboard
      </a>
      <h1>Appointment Details</h1>
      <span class="status-badge status-{{ appointment.status|lower }}">
        {{ appointment.status }}
      </span>
    </div>
  </div>

  <div class="detail-grid">
    <!-- Patient Information Card -->
    <div class="detail-card">
      <div class="card-header">
        <h2>Patient Information</h2>
      </div>
      <div class="card-content">
        <div class="info-row">
          <span class="info-label">Full Name</span>
          <span class="info-value">{{ appointment.patient_name }}</span>
        </div>
        <div class="info-row">
          <span class="info-label">Email</span>
          <span class="info-value">{{ appointment.patient_email|default:"Not provided" }}</span>
        </div>
        <div class="info-row">
          <span class="info-label">Contact Number</span>
          <span class="info-value">{{ appointment.patient_contact }}</span>
        </div>
      </div>
    </div>

    <!-- Appointment Information Card -->
    <div class="detail-card">
      <div class="card-header">
        <h2>Appointment Information</h2>
      </div>
      <div class="card-content">
        <div class="info-row">
          <span class="info-label">Date</span>
          <span class="info-value">{{ appointment.appointment_date|date:"l, F d, Y" }}</span>
        </div>
        <div class="info-row">
          <span class="info-label">Time</span>
          <span class="info-value">{{ appointment.appointment_time|time:"g:i A" }}</span>
        </div>
        <div class="info-row">
          <span class="info-label">Doctor</span>
          <span class="info-value">Dr. {{ appointment.doctor.user.get_full_name }} {{ appointment.doctor.specialization
            }}</span>
        </div>
        <div class="info-row">
          <span class="info-label">Status</span>
          <span class="info-value">
            <span class="status-badge status-{{ appointment.status|lower }}">
              {{ appointment.status }}
            </span>
          </span>
        </div>
      </div>
    </div>

    <!-- Reason for Visit Card -->
    <div class="detail-card full-width">
      <div class="card-header">
        <h2>Reason for Visit</h2>
      </div>
      <div class="card-content">
        <p class="reason-text">{{ appointment.reason }}</p>
      </div>
    </div>

    <!-- Medical Record Card (for completed appointments) -->
    {% if appointment.status == "Completed" %}
    <div class="detail-card full-width" style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);">
      <div class="card-header" style="background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);">
        <h2>Medical Record</h2>
      </div>
      <div class="card-content">
        {% if appointment.medical_record %}
        <div class="info-row">
          <span class="info-label">Subjective Notes</span>
          <span class="info-value">{{ appointment.medical_record.subjective_notes|default:"Not provided" }}</span>
        </div>
        <div class="info-row">
          <span class="info-label">Objective Findings</span>
          <span class="info-value">{{ appointment.medical_record.objective_findings|default:"Not provided" }}</span>
        </div>
        <div class="info-row">
          <span class="info-label">Diagnosis</span>
          <span class="info-value">{{ appointment.medical_record.diagnosis|default:"Not provided" }}</span>
        </div>
        <div class="info-row">
          <span class="info-label">Treatment Plan</span>
          <span class="info-value">{{ appointment.medical_record.treatment_plan|default:"Not provided" }}</span>
        </div>
        <div class="info-row">
          <span class="info-label">Follow-up Instructions</span>
          <span class="info-value">{{ appointment.medical_record.follow_up_instructions|default:"Not provided" }}</span>
        </div>
        {% else %}
        <p class="empty-text" style="text-align: center; color: #6c757d;">No medical record available yet.</p>
        {% endif %}
      </div>
    </div>
    {% endif %}

    <!-- Prescription Card -->
    {% if prescription %}
    <div class="detail-card full-width prescription-card">
      <div class="card-header">
        <h2>Prescription</h2>
      </div>
      <div class="card-content">
        <div class="info-row">
          <span class="info-label">Medication</span>
          <span class="info-value">{{ prescription.medication }}</span>
        </div>
        <div class="info-row">
          <span class="info-label">Instructions</span>
          <span class="info-value prescription-instructions">{{ prescription.instructions }}</span>
        </div>
      </div>
    </div>
    {% endif %}
  </div>

   <!-- Action Buttons -->
  <div class="action-section" style="flex-direction: column;">
    <h3>Actions</h3>
    <div class="action-buttons-group">
      {% if appointment.status == "Pending" %}
      <form method="post" action="{% url 'clinic_app:doctor_approve_appointment' appointment.id %}" class="action-form">
        {% csrf_token %}
        <button type="submit" class="btn btn-success">
          Approve Appointment
        </button>
      </form>
      <form method="post" action="{% url 'clinic_app:doctor_cancel_appointment' appointment.id %}" class="action-form"
        onsubmit="return confirm('Are you sure you want to cancel this appointment?');">
        {% csrf_token %}
        <button type="submit" class="btn btn-danger">
          Cancel Appointment
        </button>
      </form>
      {% elif appointment.status == "Approved" %}
      <form method="post" action="{% url 'clinic_app:doctor_complete_appointment' appointment.id %}"
        class="action-form">
        {% csrf_token %}
        <button type="submit" class="btn btn-primary">
          Mark as Completed
        </button>
      </form>
      {% if not prescription %}
      <a href="{% url 'clinic_app:doctor_add_prescription' appointment.id %}" class="btn btn-info">
        Add Prescription
      </a>
      {% endif %}
      {% elif appointment.status == "Completed" %}
      {% if appointment.medical_record %}
      <a href="{% url 'clinic_app:doctor_edit_medical_record' appointment.medical_record.id %}" class="btn btn-primary">
        Edit Medical Record
      </a>
      {% endif %}
      {% if not prescription %}
      <a href="{% url 'clinic_app:doctor_add_prescription' appointment.id %}" class="btn btn-info">
        Add Prescription
      </a>
      {% else %}
      <a href="{% url 'clinic_app:doctor_edit_prescription' prescription.id %}" class="btn btn-secondary">
        Edit Prescription
      </a>
      {% endif %}
      {% endif %}
    </div>
    <div class="edit-delete-buttons">
        <!-- Edit and Delete Buttons -->
        <a href="{% url 'clinic_app:appointment_edit' appointment.id %}" class="btn btn-primary">
          Edit
        </a>
        <a href="{% url 'clinic_app:appointment_delete' appointment.id %}" class="btn btn-danger" onclick="return confirm('Are you sure you want to delete this appointment?');">
          Delete
        </a>
      </div>
  </div>
{% endblock %}